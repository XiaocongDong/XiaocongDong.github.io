---
title: 浅谈现代浏览器架构(一)
tags:
  - Chrome
  - 浏览器
categories:
  - 前端
---
## 前言
本文是笔者对[Mario Kosaka](https://developers.google.com/web/resources/contributors/kosamari)的[inside look at modern web browser](https://developers.google.com/web/updates/2018/09/inside-browser-part1)系列文章的翻译。这里的翻译不是指直译，而是结合个人的理解将作者想表达的意思表达出来，而且会尽量补充一些相关的内容来帮助大家更好地理解。
## CPU，GPU，内存和多进程架构
在这个`4集系列教程`里面，我将会从Chrome浏览器的高层次架构（high-level architecture）说起，然后一直深入到页面渲染流水线（rendering pipeline）的具体细节。如果你想知道浏览器是怎么把你编写的代码转变成一个可用的网站，或者你不知道为什么一些特定的代码写法可以提高网站的性能的，那你就来对地方了，这篇文章就是为你准备的。

作为本系列文章的第一篇，我们会先看一下一些关键的计算机术语和了解一下Chrome浏览器的多进程架构。
### 计算机的核心是CPU和GPU
要想理解浏览器的运行环境，我们先要搞明白一些计算机组件以及它们的作用。
### CPU
首先我们要说的是计算机的核心 - CPU。CPU就是我们计算机的大脑。我们可以把CPU的一个核心（core）比喻成一个办公室工人，他功能强大，琴棋书画无所不能，`不过它有个缺点就是只能一件一件地处理交给它的任务`。很久之前大多数CPU只有一个核心，不过对于现在的硬件设备来说，一个CPU往往不止一个核心因为多核CPU可以大大提高你的电话和笔记本电脑的性能。
![](/images/chrome/CPU.png)
*图一：四个CPU核心像工人一样各自在工位上一个一个地处理交给它们的任务*

### GPU
图形处理器 - 或者说GPU是计算机的另外一个重要组成部分。和多才多艺的CPU核心不一样的是，单个GPU核心只擅长处理一些简单的任务，不过一个GPU芯片上会有很多个核心去同时处理任务，也就是说它的并行计算能力是非常强的。图形处理器（GPU）顾名思义一开始是专门用来处理图形的，这也就是为什么在说到图形相关的问题的时候，人们都说可以通过`使用GPU`（using）或者`GPU支持`（backed）来加快渲染过程和提高交互的流畅度。最近几年来，随着`GPU加速概念`的流行，在GPU上进行的计算也变得越来越多了。
![](/images/chrome/GPU.png)
*图二：GPU核心只能拿着个扳手干活，这就说明它们单个的能力是非常有限的*

当你在手机或者电脑上启动应用的时候，其实就是CPU和GPU在背后支撑着你的应用的运行。不过通常来说，你的应用是跑在操作系统上面而不是直接跑在CPU和GPU上面。
![](/images/chrome/hw-os-app.png)
*图三：计算机的三层架构，最下层是硬件，操作系统是中间层，然后又应用跑在最上层*

### 在进程和线程上执行程序
在深入浏览器的架构之前我们还得了解一下关于进程（process）和线程（thread）的概念。进程可以看做成正在被执行的程序（executing program）。而线程是跑在进程里面的，一个进程里面可能有一个或者多个线程，这些线程可以执行应用任何一部分的代码。
![](/images/chrome/process-thread.png)
*图四：进程可以看成一个大鱼缸，而线程可以看做成在浴缸里面畅游的鱼儿*

当你启动一个应用的时候，操作系统就会创建一个进程。为了功能的需要，这个进程可能会创建一些线程，不过这不是必须的。在系统为程序创建一个进程的时候会为这个进程分配一片私有的内存空间，这片空间用来存储这个程序的所有数据和状态。当你关闭这个应用的时候，这个应用对应的进程也会消失，进程对应的内存空间也会被操作系统释放掉。
![](/images/chrome/memory.svg)
*图五：展示进程如何使用分配的内存空间去存储应用的数据*

进程同样也可以叫操作系统创建另外一些新的进程去做帮忙处理一些事情，不过新建的进程会拥有一个全新的内存空间而不是和原来的进程公用内存空间，所有它们要通过一些**IPC**机制（Inter Process Communication）来进行通信。很多应用都采用这种`多进程的方式`来工作，因为在多进程架构下，进程之间是相互独立的，换句话来书，如果其中一个工作进程挂掉了其他进程不会受到影响，而且挂掉的进程还可以被重启。
![](/images/chrome/workerprocess.svg)
*图六：不同的进程可以通过IPC来通信*

### 浏览器架构
那么浏览器是怎么使用进程来线程来构建的呢？其实有两种方式，一种是单进程模式，也就是一个进程里面有很多个不同的线程，第二种方式是多进程，也就是浏览器有多个进程在工作，每个进程里面有不同的线程，进程和进程之间通过IPC进行通信。
![](/images/chrome/browser-arch.png)
*图七：单进程和多进程浏览器各自的架构图*

要注意的是上面的图表其实包含了不同浏览器架构的具体实现了，不过真是中的浏览器可不并不是这么实现的，毕竟没有一个大家遵循的实现浏览器的标准在那，所以在现实生活中不同浏览器的实现方式可能会完全不一样。

为了更好地在本系列文章进行论述，我们将会采用Chrome最近的架构为论述对象，它的架构图具体如下：
![](/images/chrome/browser-arch2.png)
*图八：Chrome的多进程架构图。多个渲染进程的卡片（render process）是用来表明Chrome会为每一个tab创建一个渲染进程。*

上图中在最上面的是浏览器进程（browser process），它会和其他进程一起协作来实现浏览器的功能。这里要注意的是Chrome会尽可能为每个tab都创建一个独立的进程，如果有可能，Chrome甚至还会为页面的iframe分配一个进程（具体可以参考[Site Isolation](https://developers.google.com/web/updates/2018/09/inside-browser-part1#site-isolation)）。当然如果性能不允许的话，`Chrome会通过相同url公用一个进程`的方法来减少进程的创建。

### 各个进程都具体负责什么内容呢？
以下是各个进程具体控制的东西：

| 进程     | 负责的工作                                                                                                                                   |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| Browser  | 控制浏览器“Chrome”的部分, 这包括书签, 前进和后退按钮. 这个进程同样还会控制那些看不见的部分，包括网络请求的发送以及文件的读写。               |
| Renderer | 控制一个tab内展示网页的所有内容                                                                                                              |
| Plugin   | 控制网页使用的所有插件，例如flash插件。                                                                                                      |
| GPU      | 处理独立于其它进程的GPU任务，也就是负责界面的渲染。它之所以被独立为一个进程是因为它要处理来自于不同tab的渲染请求并把它在同一个界面上画出来。 |
![](/images/chrome/browserui.png)
*图九：不同的进程负责不同的浏览器界面内容*

除了上面列出来的进程，Chrome还有很多其他诸如扩展进程（Extension Process）和工具进程（utility process）。如果你想看一下你的Chrome浏览器现在有多少个进程在跑可以点击浏览器右上角的更多按钮，选择更多工具和任务管理器：
![](/images/chrome/devtool.png)
在弹出的窗口里面你会看到一个现在浏览器正在工作的进程列表，以及每个进程使用的CPU和内存状况。

### Chrome多进程架构的好处
那么为什么Chrome会采取多进程的架构呢？在大多数简单的情景，Chrome会为每个tab单独分配一个属于它们的渲染进程（render process）。换句话说，假如你有三个tab，你就会有三个独立的渲染进程。这样做的原因是当其中一个tab的崩溃时，你可以优雅地关闭这个tab并且保证其他tab的内容不受到影响。如果所有的tab都跑在同一个进程的话，当一个tab挂了，其他的tab都会挂。
![](/images/chrome/tabs.svg)
*不同的tab会有不同的渲染进程来负责*

Chrome采用多进程架构的另外一个好处就是可以提供安全性和隔离性。因为对于进程来说，操作系统可以限制它们拥有的能力，这样浏览器就可以将不能的功能放在不同的进程里面独立实现。例如，由于tab里面的渲染进程会处理来自用户的随机输入，所以Chrome限制了它们对系统文件随机读写的能力。

不过多进程架构也有它不好的地方。由于每个进程都会有各自独立的内存空间，所以它们不同像那种在同一个进程里面不同线程公用内存空间，这就造成了一个基础的架构（例如V8 JavaScript引擎）会在不同进程的内存空间同时存在。重复的内容就会消耗更多的内存，所以为了节省内存，Chrome会限制被启动的进程数，当Chrome的进程数达到一定的限制后，Chrome会在同一个进程里面启动同一个源的tab。

### 节省更多的内存 - Chrome服务化
同样的方法也可以被使用在浏览器进程（browser process）上面。Chrome现在正在经历一系列的架构改变，思路是将浏览器自身相关的部分拆分为一个个不同的服务，这样它们就可以很容易地被用不同的进程执行或者将它们并进同一个进程执行。

具体的做法是，当Chrome在一些性能比较好的硬件上执行的时候，浏览器相关的程序会被拆分成不同的服务在不同的进程执行，因为运行在不同的进程可以提高程序的稳定性。不过如果运行的硬件性能不好，Chrome就会将这些服务放在同一个进程里面执行来节省内存消耗。在这次架构变化之前，其实Chrome在Android上面已经开始采取类似的做法了，比较手机的配置和电脑比起来实在太小了。
![](/images/servicfication.svg)
*Chrome将不同浏览器相关的程序拆分为不同的服务放在不同的进程运行以及放在同一个进程里面运行的图示*

### 单帧渲染进程 - 网站隔离（Site Isolation）
[网站隔离](https://developers.google.com/web/updates/2018/07/site-isolation)（Site Isolation）功能最近被Chrome使用来给每个跨站的iframe分配一个独立的渲染进程。我们之前一直在说要为每个tab分配一个渲染进程，这样的话不同站点的iframes会跑在同一个进程，这也意味着它们拥有共享内存。在用一个进程里面跑a.com和b.com两个网站看起来可能没有很大的问题。[同源策略](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy)是浏览器最核心的安全模型，它可以保证一个网站不可以在未经同意的情况下去获取另外一个源的数据。这样绕过同源策略是很多安全攻击的重要目的。而进程隔离是隔离这些网站的最好最有效的办法了。在Google的Zero项目发现CPU的[Meltdown和Spectre](https://developers.google.com/web/updates/2018/02/meltdown-spectre)问题后，我们更需要将不同源的网站放在不同的进程执行了。在Chrome 67版本之后，桌面版的Chrome会默认开启网站隔离功能，这样每一个跨站点的iframe都会拥有一个独立的渲染进程。
![](/images/chrome/isolation.png)
*使用了网站隔离功能后，不同的网站iframe会拥有不同的进程*
网站隔离技术历经了几年的开发才最终被研发出来，它其实远远远远没有想象中只是为不同站点的iframe分配一个独立的渲染进程那么简单，因为它从根本上改变了各个iframes之间的通信方式。对于有iframes的网站，当用户打开右边的devtools时，Chrome浏览器其实要做很多工作才能让开发者感觉不出和之前的开发有什么区别。这其实是很难做到的，例如你在devtool里面运行Ctrl+F去在各个iframe里面去搜索东西的时候其实Chrome要遍历多个渲染进程去完成这个功能。所以当网站隔离这个功能完整之后我们的浏览器工程师都感叹这是浏览器开发的一个里程碑。

### 总结
在本篇文章中，我们探讨了浏览器高层次的架构设计以及多进程架构的带来的好处。同时我们还讨论了服务化和网站隔离这些和浏览器多进程架构息息相关的技术。在下一篇文章中我们要开始深入我们先前提到的进程和线程是如何将我们的网站展示给用户的了。
