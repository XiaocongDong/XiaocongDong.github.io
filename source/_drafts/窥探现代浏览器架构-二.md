---
title: 窥探现代浏览器架构(二)
tags:
---
## 前言
本文是笔者对[Mario Kosaka](https://developers.google.com/web/resources/contributors/kosamari)写的[inside look at modern web browser](https://developers.google.com/web/updates/2018/09/inside-browser-part2)系列文章的翻译。这里的翻译不是指直译，而是结合个人的理解将作者想表达的意思表达出来，而且会尽量补充一些相关的内容来帮助大家更好地理解。
## 导航的时候都发生了什么
这篇文章是探究Chrome内部工作原理的**四集系列文章**中的第二篇，在[上一篇](prev_post)文章中我们简单讨论了一下不同进程或者线程是如何负责浏览器不同部分的工作的。在这篇文章中，我们将会更加深入地了解每个进程和线程是如何沟通协作来为我们呈现出网站内容的。

让我们来看一个浏览网页最简单的情景：你在浏览器导航栏里面输入一个URL然后按下回车键，浏览器接着会从互联网上获取相关的数据并把它展示出来。在本篇文章中，我们将会重点关注这个简单场景中用户请求网站数据以及浏览器在呈现网页之前做的准备工作 - 也就是导航（navigation）的过程。

## 从浏览器进程开始
我们之前在上一篇文章[CPU，GPU，内存和多进程架构](prev_post)中提到，浏览器上面除了标签（tab）外的其他所有工作都是由浏览器进程处理的（browser process）。浏览器进程有很多不同的线程，其中包括负责绘制页面按钮表单组件等的UI线程（UI thread），负责从互联网上首发数据的网络线程（network thread），以及控制文件读写的存储线程（storage thread）等。
![](/images/chrome/browserprocesses.png)
<p align="center">UI，网络和存储线程存在于浏览器进程里面</p>

当你在导航栏里面输入一个URL的时候，其实是浏览器进程里面的UI线程在处理的输入。

## 一次简单的导航
### 第一步：处理输入
当用户开始在导航栏上面输入内容的时候，UI线程做的第一件事是问：“你输入的东西是一个搜索的关键词还是一个URL地址呢？”。对于Chrome浏览器，导航栏其实也是一个搜索引擎的输入框，所以用户输入东西的时候UI线程要进行一系列的解析来判定是将用户输入发送给搜索引擎还是直接请求你输入的站点资源。
![](/images/chrome/input.png)
<p align="center">UI线程在询问输入的字符串是搜索关键词还是一个URL</p>

### 第二步：开始导航
当用户按下回车键的时候，UI线程会初始化一个网络请求来获取站点的内容。这时候tab上会展示一个提示资源正在加载中的旋转圈圈，而且网络线程（network thread）会通过一系列例如DNS的网络协议和目标服务器建立TLS链接。
![](/images/chrome/navstart.png)
<p align="center">UI线程告诉网络线程跳转到mysite.com</p>

在这个时候，网络线程可能收到一个来自于服务器的301重定向响应，这个时候网络线程就会告诉UI线程服务器要求进行重定向然后它就会再次发起一个网络请求。

### 第三步：读取响应
一旦网络线程收到网络请求的响应（response body），如果有必要的话它会查看头几个