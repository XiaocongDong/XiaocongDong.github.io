---
title: 窥探现代浏览器架构(二)
tags:
---
## 前言
本文是笔者对[Mario Kosaka](https://developers.google.com/web/resources/contributors/kosamari)写的[inside look at modern web browser](https://developers.google.com/web/updates/2018/09/inside-browser-part2)系列文章的翻译。这里的翻译不是指直译，而是结合个人的理解将作者想表达的意思表达出来，而且会尽量补充一些相关的内容来帮助大家更好地理解。
## 导航的时候都发生了什么
这篇文章是探究Chrome内部工作原理的**四集系列文章**中的第二篇，在[上一篇](prev_post)文章中我们简单讨论了一下不同进程或者线程是如何负责浏览器不同部分的工作的。在这篇文章中，我们将会更加深入地了解每个进程和线程是如何沟通协作来为我们呈现出网站内容的。

让我们来看一个浏览网页最简单的情景：你在浏览器导航栏里面输入一个URL然后按下回车键，浏览器接着会从互联网上获取相关的数据并把它展示出来。在本篇文章中，我们将会重点关注这个简单场景中用户请求网站数据以及浏览器在呈现网页之前做的准备工作 - 也就是导航（navigation）的过程。

## 从浏览器进程开始
我们在上一篇文章[CPU，GPU，内存和多进程架构](prev_post)中提到，浏览器这个应用程序标签之外发生的一切都是由浏览器进程处理的（browser process）。浏览器进程有很多不同的线程，其中包括负责绘制按钮和导航栏输入框等组件的UI线程（UI thread）、负责从互联网上收发数据的网络线程（network thread）、以及控制文件读写的存储线程（storage thread）等。
![](/images/chrome/browserprocesses.png)
<p align="center">UI，网络和存储线程存在于浏览器进程里面</p>

当你在导航栏里面输入一个URL的时候，其实是浏览器进程里面的UI线程在处理的输入。

## 一次简单的导航
### 第一步：处理输入
当用户开始在导航栏上面输入内容的时候，UI线程（UI thread）做的第一件事就是询问：“你输入的字符串是一些搜索的关键词（search query）还是一个URL地址呢？”。因为对于Chrome浏览器来说，导航栏的输入可能是一个可以直接请求的域名还可能是用户想在搜索引擎（例如Google）里面搜索的关键词信息，所以当用户在导航栏输入信息的时候UI线程要进行一系列的解析来判定是将用户输入发送给搜索引擎还是直接请求你输入的站点资源。
![](/images/chrome/input.png)
<p align="center">UI线程在询问输入的字符串是搜索关键词还是一个URL</p>

### 第二步：开始导航
当用户按下回车键的时候，UI线程会叫网络线程（network thread）初始化一个网络请求来获取站点的内容。这时候tab上会展示一个提示资源正在加载中的旋转圈圈，而且网络线程会进行一系列诸如DNS寻址以及为请求建立TLS连接等操作。
![](/images/chrome/navstart.png)
<p align="center">UI线程告诉网络线程跳转到mysite.com</p>

在这个时候，网络线程可能收到一个来自于服务器的HTTP 301重定向响应。网络线程就会告诉UI线程服务器要求进行重定向然后它就会再次发起一个网络请求。

### 第三步：读取响应
网络线程在收到HTTP响应的内容（payload）流（stream）时，在必要的情况下它会先检查一下流的前几个字节以确定响应内容的具体类型（MIME Type）。响应内容的具体类型一般可以通过HTTP头部的Content-Type来确定，不过这个Content-Type有时候会缺失或者是错误的，这种情况下浏览器就要进行[MIME类型嗅探](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types)来确定响应类型了。MIME类型嗅探并不是一件很容易的事情，这个你可以从[Chrome的源代码](https://cs.chromium.org/chromium/src/net/base/mime_sniffer.cc?sq=package:chromium&dr=CS&l=5)看出来，通过代码的注释你可以了解到不同浏览器是如何根据不同的Content-Type去判断出内容是属于哪个媒体类型的。
![](/images/chrome/response/png)
<p align="center">包含Content-Type的响应头部以及响应的</p>

如何响应的内容是一个HTML文件，浏览器会将获取的响应数据交给渲染进程来进行下一部的工作，不过如果拿到的响应数据是一个压缩文件（zip file）或者其他类型的文件的话，这个数据就会交给下载管理器（download manager）来处理。
![](/images/chrome/sniff.png)
<p align="center">网络线程在询问响应的数据是不是来自安全源的HTML文件</p>

在获取到响应后，网络线程同时还会做[SafeBrowsing](https://safebrowsing.google.com/)的安全监测。如果请求的域名或者响应的内容和某个已知的病毒网站相匹配的话，网络线程会给用户展示一个警告的页面。除此之外，网络线程还会做CORB（**C**ross **O**rigin **R**ead **B**locking）检查来确定那些敏感的跨站点数据不会被发送至渲染进程。

### 第四部：寻找一个渲染进程（renderer process）
在网络线程做完所有的检查后并且能够确定浏览器应该导航到该请求的站点，它就会告诉UI线程所有的数据都已经被准备好了，UI进程接着就会找到一个渲染进程（renderer process）来负责这个页面的渲染。
![](/images/chrome/findrenderer.png)
<p align="center">网络线程告诉UI线程去寻找一个渲染进程来渲染界面</p>

由于每个